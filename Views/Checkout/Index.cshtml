@model Ecomm.Models.CheckoutViewModel
@using Ecomm.Helpers
@{
    ViewData["Title"] = "Checkout";
}


<div class="checkout-container">
    <h2 class="title">Checkout</h2>

    <form id="checkoutForm" method="post" action="/Checkout/ProcessOrderAPI">
        <div class="checkout-grid">

            <!-- CUSTOMER INFO -->
            <div class="card">
                <h3>Customer Information</h3>
                <div class="field-row">
                    <input name="FullName" placeholder="Full Name" required />
                    <input name="Email" placeholder="Email" type="email" required />
                </div>
                <input name="Phone" placeholder="Phone Number" required />
                <textarea name="Address" placeholder="Shipping Address" required></textarea>

                <div class="field-row">
                    <input name="City" placeholder="City" required />
                    <input name="ZipCode" placeholder="ZIP Code" required />
                </div>
            </div>

            <!-- PAYMENT SECTION -->
            <div class="card">
                <h3>Mobile Money Payment</h3>

                <div class="providers">
                    <label class="provider"><input type="radio" name="provider" value="MTN" checked> MTN Mobile Money</label>
                    <label class="provider"><input type="radio" name="provider" value="Airtel"> Airtel Money</label>
                </div>

                <input id="mmNumber" name="MobileMoneyNumber" placeholder="Mobile Money Number (2567...)" required />

                <label class="terms-label">
                    <input type="checkbox" id="agreeTerms" required />
                    I agree to the payment terms and authorize charge.
                </label>

                <button type="submit" id="payBtn" class="btn-primary">Pay Now</button>

                <div id="processing" class="processing hidden">Processing payment...</div>
            </div>

        </div>
    </form>
</div>

<script>
    // Asynchronous API Payment Submission
    document.getElementById("checkoutForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const provider = document.querySelector("input[name='provider']:checked").value;
        const number = document.getElementById("mmNumber").value;

        document.getElementById("payBtn").classList.add("hidden");
        document.getElementById("processing").classList.remove("hidden");

        // CALL THE API CONTROLLER ENDPOINT
        const response = await fetch('/Checkout/InitiateMobileMoneyPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider: provider, number: number })
        });

        const result = await response.json();

        if (result.success) {
            alert('Payment request sent. Please approve prompt on your phone.');
            this.submit(); // Submit actual order
        } else {
            alert('Payment failed: ' + result.message);
            document.getElementById("payBtn").classList.remove("hidden");
            document.getElementById("processing").classList.add("hidden");
        }
    });
</script>

<style>
    .checkout-container {
        max-width: 1100px;
        margin: auto;
        padding: 20px;
    }

    .title {
        text-align: center;
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0px 3px 10px rgba(0,0,0,0.1);
    }

    .field-row {
        display: flex;
        gap: 10px;
    }

    input, textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .providers {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .provider {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        flex: 1;
        cursor: pointer;
    }

    .btn-primary {
        width: 100%;
        background: #007bff;
        border: none;
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        cursor: pointer;
    }

    .processing {
        text-align: center;
        padding: 10px;
    }

    .hidden {
        display: none;
    }
</style>
