@model Ecomm.Models.Product
@{
    ViewData["Title"] = "Product Details";
}

<style>
    /* WRAPPER */
    .amazon-container {
        max-width: 1300px;
        margin: auto;
        padding: 2rem 1rem;
        font-family: Arial, sans-serif;
    }

    /* BREADCRUMB */
    .amazon-breadcrumb nav {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 1rem;
    }

    .amazon-breadcrumb a {
        color: #007185;
        text-decoration: none;
    }

    .amazon-breadcrumb .active {
        color: #111;
    }

    /* GRID (Amazon layout: Image / Info / Buybox) */
    .amazon-grid {
        display: grid;
        grid-template-columns: 1.4fr 2fr 1.2fr;
        gap: 2rem;
    }

    /* IMAGE */
    .amazon-main-img {
        width: 100%;
        border-radius: 12px;
        background: #f5f5f5;
        padding: 1rem;
    }

    /* INFO MIDDLE SECTION */
    .amazon-title {
        font-size: 1.9rem;
        font-weight: 600;
        color: #111;
    }

    .amazon-category {
        margin-bottom: 1rem;
        color: #555;
    }

        .amazon-category a {
            color: #007185;
        }

    /* PRICE */
    .amazon-price-box {
        font-size: 1.7rem;
        margin: 1rem 0;
    }

    .amazon-price {
        color: #4861ee;
        font-weight: 700;
    }

    .amazon-sale-tag {
        margin-left: 1rem;
        padding: 0.3rem .8rem;
        background: #4861ee;
        font-size: 0.9rem;
        border-radius: 4px;
    }

    /* STOCK */
    .in-stock {
        color: #4861ee;
        font-weight: 700;
    }

    .low-stock {
        color: #B12704;
        margin-left: .5rem;
    }

    .out-stock {
        color: #B12704;
        font-weight: 700;
    }

    /* DESCRIPTION */
    .amazon-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: .6rem;
    }

    .amazon-description {
        color: #333;
        line-height: 1.6;
    }

    /* QUANTITY + ADD TO CART */
    .amazon-quantity-box {
        margin-top: 1.5rem;
    }

    .amazon-qty-input {
        width: 50px;
        padding: 5px;
        margin-left: .5rem;
        border: 1px solid #bbb;
        border-radius: 3px;
    }

    /* BUTTONS */
    .amazon-btn-yellow {
        background: #4861ee;
        border: 1px solid #4861ee;
        padding: .7rem 1rem;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        font-size: 12px;
    }

        .amazon-btn-yellow:hover {
            background: #4861ee;
        }

    .amazon-btn-orange {
        background: #4861ee;
        border: 1px solid #4861ee;
        padding: .7rem 1rem;
        border-radius: 50px;
        font-weight: bold;
        color: #fff;
    }

        .amazon-btn-orange:hover {
            background: #4861ee;
        }

    .amazon-btn-disabled {
        background: #ddd;
        border-radius: 50px;
        padding: 1rem;
        font-size: 1.2rem;
    }

    /* BUYBOX RIGHT */
    .amazon-buybox {
        border: 1px solid #ddd;
        padding: 1.5rem;
        border-radius: 12px;
        background: #fafafa;
    }

    .buybox-price {
        color: #B12704;
        font-size: 1.8rem;
        font-weight: 700;
    }

    /* SECURE */
    .secure-transaction {
        color: #007185;
        font-size: .9rem;
    }

    /* ADMIN */
    .amazon-admin-box h6 {
        font-weight: bold;
        margin-bottom: .6rem;
    }

    .amazon-admin-btn {
        display: inline-block;
        padding: .5rem 1rem;
        border-radius: 6px;
        color: #fff;
        margin-right: .5rem;
        text-decoration: none;
    }

        .amazon-admin-btn.edit {
            background: #007185;
        }

        .amazon-admin-btn.delete {
            background: #B12704;
        }

    /* RESPONSIVE */
    @@media (max-width: 992px) {
        .amazon-grid

    {
        grid-template-columns: 1fr 1fr;
    }

    }

    @@media (max-width: 768px) {
        .amazon-grid

    {
        grid-template-columns: 1fr;
    }

    .amazon-buybox {
        max-width: 350px;
        margin: auto;
    }

    }
</style>

<div class="amazon-container">

    <!-- AMAZON-STYLE BREADCRUMB -->
    <div class="amazon-breadcrumb">
        <nav>
            <a href="@Url.Action("Index", "Home")">Home</a>
            <span>›</span>
            <a href="@Url.Action("Index", "Products")">Products</a>
            <span>›</span>
            <span class="active">@Model.Name</span>
        </nav>
    </div>

    <div class="row align-items-start g-4">

        <!-- LEFT: PRODUCT IMAGE -->
        <div class="col-lg-6 col-md-6 col-12">
            <div class="product-image-wrapper">
            @{
                var imageUrl = !string.IsNullOrEmpty(Model.ImageUrl)
                ? Model.ImageUrl
                : $"https://picsum.photos/600/500?random={Model.Id}";
            }

                <img src="@imageUrl"
                 class="amazon-main-img"
                 alt="@Model.Name"
                 onerror="this.src='https://via.placeholder.com/600x500/667eea/ffffff?text=No+Image+Available'">
            </div>
        </div>

        <!-- RIGHT: PRODUCT DETAILS -->
        <div class="col-lg-6 col-md-6 col-12">
            <div class="product-image-wrapper">
                <h1 class="amazon-title">@Model.Name</h1>

            <div class="amazon-category">
                Category: <a>@(Model.Category?.Name ?? "Uncategorized")</a>
            </div>

            <hr />

            <!-- PRICE -->
            <div class="amazon-price-box">
                <span class="amazon-price">@Model.Price.ToString("C2")</span>

                @if (Model.IsOnSale)
                {
                    <span class="amazon-sale-tag">On Sale</span>
                }
            </div>

            <!-- STOCK -->
            <div class="amazon-stock">
                @if (Model.StockCount > 0)
                {
                    <span class="in-stock">In Stock</span>

                    @if (Model.StockCount <= 10)
                    {
                        <span class="low-stock">Only @Model.StockCount left!</span>
                    }
                }
                else
                {
                    <span class="out-stock">Out of Stock</span>
                }
            </div>

            <hr />

            <!-- DESCRIPTION -->
            <h4 class="amazon-section-title">About this item</h4>
            <p class="amazon-description">
                @Model.Description
            </p>

            <hr />

            <!-- QUANTITY + ADD TO CART -->
            @if (Model.StockCount > 0)
            {
                <div class="amazon-quantity-box">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="productId" value="@Model.Id">

                    <label>Quantity:</label>
                    <input type="number"
                           id="quantity"
                           class="amazon-qty-input"
                           value="1"
                           min="1"
                           max="@Model.StockCount" />

                    <button id="addToCartBtn"
                            type="button"
                            class="amazon-btn-yellow">
                        <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        <span class="spinner-border spinner-border-sm d-none" id="addToCartSpinner"></span>
                    </button>
                        @{
                            string phone = "256700000000"; // Your WhatsApp contact
                            string message = $"Hello, I would like to inquire about {Model.Name}";
                            string encodedMessage = Uri.EscapeDataString(message);
                            string waLink = $"https://wa.me/{phone}?text={encodedMessage}";
                        }

                        <a href="@waLink" target="_blank" class="btn btn-success mt-3 w-100">
                            <i class="fab fa-whatsapp me-2"></i> Chat with Seller on WhatsApp
                        </a>

                </div>
            }
            else
            {
                <button class="amazon-btn-disabled w-100">
                    <i class="fas fa-times-circle me-2"></i>Currently Unavailable
                </button>
            }

            <!-- ADMIN ACTIONS -->
            @if (User.IsInRole("Admin"))
            {
                <div class="amazon-admin-box mt-4">
                    <h6>Admin Actions</h6>
                    <a class="amazon-admin-btn edit" href="@Url.Action("Edit", "Products", new { id = Model.Id })">
                        <i class="fas fa-edit me-2"></i>Edit
                    </a>
                    <a class="amazon-admin-btn delete" href="@Url.Action("Delete", "Products", new { id = Model.Id })">
                        <i class="fas fa-trash me-2"></i>Delete
                    </a>
                </div>
            }

        </div>
        </div>

    </div>
</div>


<!-- Enhanced Toast Notification -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Product added to cart!
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#addToCartBtn').click(function() {
                addToCart();
            });

            $('#quantity').keypress(function(e) {
                if (e.which === 13) {
                    addToCart();
                }
            });
        });

        async function addToCart() {
            const productId = $('#productId').val();
            const quantity = parseInt($('#quantity').val());
            const button = $('#addToCartBtn');
            const spinner = $('#addToCartSpinner');

            if (quantity < 1 || quantity > @Model.StockCount) {
                showToast('Please enter a valid quantity', 'error');
                return;
            }

            button.prop('disabled', true);
            spinner.removeClass('d-none');

            try {
                const token = $('input[name="__RequestVerificationToken"]').val();

                const response = await fetch('/Cart/AddToCart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({
                        productId: parseInt(productId),
                        quantity: quantity
                    })
                });

                if (response.status === 401) {
                    showToast('Please login to add items to cart', 'error');
                    setTimeout(() => {
                        window.location.href = '/Identity/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                    }, 2000);
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    showToast(result.message);
                    updateCartCount(result.cartCount);

                    // Success animation
                    button.html('<i class="fas fa-check"></i> Added to Cart!');
                    setTimeout(() => {
                        button.html('<i class="fas fa-shopping-cart me-2"></i>Add to Cart');
                    }, 2000);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('401') || error.message.includes('unauthorized')) {
                    showToast('Please login to add items to cart', 'error');
                    setTimeout(() => {
                        window.location.href = '/Identity/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                    }, 2000);
                } else {
                    showToast('Network error. Please try again.', 'error');
                }
            } finally {
                button.prop('disabled', false);
                spinner.addClass('d-none');
            }
        }

        function showToast(message, type = 'success') {
            const toastElement = $('#cartToast');
            const toastMessage = $('#toastMessage');

            toastMessage.text(message);

            if (type === 'error') {
                toastElement.find('.toast-header').removeClass('bg-success').addClass('bg-danger')
                    .html('<i class="fas fa-exclamation-circle me-2"></i><strong class="me-auto">Error</strong><button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>');
            } else {
                toastElement.find('.toast-header').removeClass('bg-danger').addClass('bg-success')
                    .html('<i class="fas fa-check-circle me-2"></i><strong class="me-auto">Success</strong><button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>');
            }

            const toast = new bootstrap.Toast(toastElement[0]);
            toast.show();
        }

        function updateCartCount(count) {
            const cartCountElements = $('.cart-count, #cartCount, [data-cart-count]');

            if (cartCountElements.length > 0) {
                cartCountElements.each(function() {
                    const element = $(this);
                    element.text(count);
                    element.show();

                    if (count === 0) {
                        element.removeClass('bg-danger').addClass('bg-secondary');
                    } else {
                        element.removeClass('bg-secondary').addClass('bg-danger');
                    }
                });
            }
        }
    </script>
}